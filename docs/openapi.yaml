openapi: 3.0.3
info:
  title: inLobby Hotel APIs
  version: 0.1.0

servers:
  - url: http://localhost:5000/api/v1

tags:
  - name: Suppliers/GoGlobal
    description: Live supplier endpoints (read-only in Swagger UI)
  - name: Bookings (Platform)
    description: Platform-level booking API (creates & manages local orders; may call suppliers internally)
  - name: Orders/Hotel
    description: Manage & review hotel orders created via suppliers.

paths:
  /suppliers/goglobal/availability:
    get:
      tags: [Suppliers/GoGlobal]
      summary: Availability (GoGlobal OT=11 mirror; ResponseFormat=JSON)
      description: >
        Uses supplier's default/profile/destination currency (we do NOT force UI currency).
        Backend may also compute AMD mirrors via GlobalSettings for internal sorting/filtering.
      operationId: goglobalAvailability
      parameters:
        - in: query
          name: cityId
          required: true
          schema: { type: string }
          description: Internal/supplier city identifier (e.g. "563")
        - in: query
          name: arrivalDate
          required: true
          schema: { type: string, format: date }
          description: YYYY-MM-DD (պահիր ≥30 օր ապագայում թեստավորման համար)
        - in: query
          name: nights
          required: true
          schema: { type: integer, minimum: 1 }
        - in: query
          name: rooms
          required: false
          schema: { type: integer, default: 1, minimum: 1, maximum: 9 }
          description: Number of rooms (max 9)
        - in: query
          name: adults
          required: false
          schema: { type: string, default: "2" }
          description: >
            Adults per room. Accepts single value or CSV per-room, e.g. "2" or "2,2".
            When CSV is shorter than rooms, first value is used for remaining rooms.
        - in: query
          name: children
          required: false
          schema: { type: string, default: "0" }
          description: >
            Children count per room. Accepts single value or CSV per-room, e.g. "0" or "0,1".
        - in: query
          name: childrenAges
          required: false
          schema: { type: string }
          description: >
            Children ages. For a single room use "5,9". For per-room groups use pipes, e.g. "5|9,11".
            Each room's ages list is truncated to that room's children count.
          examples:
            singleRoom:
              summary: Ages for one room
              value: "5,9"
            perRoom:
              summary: "First room: age 5; second room: ages 9 & 11"
              value: "5|9,11"
        - in: query
          name: nationality
          required: false
          schema: { type: string, minLength: 2, maxLength: 2 }
          example: AM
          description: ISO 3166-1 alpha-2 (e.g. AM, GB). Optional; if omitted, supplier default may apply.
        - in: query
          name: filterBasis
          required: false
          schema: { type: string }
          description: >
            Filter by board basis, CSV (e.g. "BB,HB"). If omitted, all basises.
        - in: query
          name: minStars
          required: false
          schema: { type: integer, minimum: 0, maximum: 5 }
          description: Client-side filter on normalized stars (inclusive).
        - in: query
          name: maxStars
          required: false
          schema: { type: integer, minimum: 0, maximum: 5 }
          description: Client-side filter on normalized stars (inclusive).
        - in: query
          name: priceMin
          required: false
          schema: { type: number, format: float }
          description: Client-side filter on minPrice.amount (retail preview) — inclusive.
        - in: query
          name: priceMax
          required: false
          schema: { type: number, format: float }
          description: Client-side filter on minPrice.amount (retail preview) — inclusive.
        - in: query
          name: sort
          required: false
          schema:
            type: string
            enum: [price_asc, price_desc, stars_desc, stars_asc, name_asc]
            default: price_asc
          description: Client-side sort.
        - in: query
          name: currency
          required: false
          schema: { type: string, minLength: 3, maxLength: 3 }
          description: >
            UI/meta currency hint (ISO-4217). NOT sent to supplier; used only for response meta.
        - in: query
          name: includeInfo
          required: false
          schema: { type: boolean, default: false }
          description: When true, enrich top-N hotels with description/facilities/pictures from Hotel Info.
        - in: query
          name: infoLimit
          required: false
          schema: { type: integer, default: 3, minimum: 1, maximum: 10 }
          description: How many top hotels to enrich (applies when includeInfo=true).
        - in: query
          name: infoLang
          required: false
          schema: { type: string, default: en }
          description: Info language (supplier supports en/…).
        - in: query
          name: maxHotels
          required: false
          schema: { type: integer, default: 150 }
        - in: query
          name: maxOffers
          required: false
          schema: { type: integer, default: 5 }
        - in: query
          name: maximumWaitTime
          required: false
          schema: { type: integer, default: 15 }
        - in: header
          name: X-Debug-Role
          required: false
          schema:
            type: string
            enum: [guest, b2c, office_user, b2b_sales_partner]
          description: Debug only. Overrides req.user.role for pricing/markup in this request.
        - in: header
          name: X-Debug-Markup
          required: false
          schema:
            type: number
            format: float
            minimum: 0
            maximum: 100
          description: Debug only. Used when X-Debug-Role=b2b_sales_partner to set a custom markup %.
      responses:
        "200":
          description: Normalized hotels & offers
          content:
            application/json:
              schema:
                type: object
                properties:
                  hotels:
                    type: array
                    items:
                      $ref: "#/components/schemas/Hotel"
                  searchContext:
                    type: object
                    properties:
                      arrivalDate: { type: string, format: date }
                      nights: { type: integer }
                      rooms: { type: integer }
                      adultsCSV: { type: string }
                      childrenCSV: { type: string }
                      childrenAgesCSV: { type: string }
                      currencyUsed:
                        type: string
                        nullable: true
                  meta:
                    type: object
                    properties:
                      provider: { type: string, example: goglobal }
                      currencyUsed: { type: string, nullable: true }
                      total: { type: integer }
                      hydration:
                        type: object
                        properties:
                          requestedCityId: { type: string }
                          matchedCodes: { type: integer }
                          matchedInDb: { type: integer }
                      roleMarkupPct:
                        type: number
                        description: Office-only (debug)
              examples:
                sample:
                  value:
                    searchContext:
                      arrivalDate: "2025-11-11"
                      nights: 3
                      rooms: 2
                      adultsCSV: "2,1"
                      childrenCSV: "1,2"
                      childrenAgesCSV: "5|9,11"
                      currencyUsed: "USD"
                    meta:
                      provider: "goglobal"
                      currencyUsed: "USD"
                      total: 1
                      hydration:
                        requestedCityId: "563"
                        matchedCodes: 1
                        matchedInDb: 1
                    hotels:
                      - _id: "875154"
                        name: "HOLIDAY INN DUBAI AL-MAKTOUM AIRPORT"
                        stars: 4
                        thumbnail: null
                        images:
                          - url: "https://i.travelapi.com/lodging/..."
                            isMain: true
                        rating: 0
                        reviewsCount: 0
                        externalRating: null
                        location:
                          city: "Dubai"
                          country: "UNITED ARAB EMIRATES"
                          address: "NEAR  AIRPORT"
                          lat: null
                          lng: null
                        externalSource:
                          provider: "goglobal"
                          hotelCode: "875154"
                          cityId: "563"
                        minOffer:
                          price: { amount: 575, currency: "USD" }
                          board: "BB"
                          refundable: true
                          cxlDeadline: "2025-10-30"
                          cancellation:
                            supplier:
                              {
                                refundable: true,
                                deadlineUtc: "2025-10-30T00:00:00Z",
                              }
                            platform:
                              {
                                refundable: false,
                                cutoffUtc: "2025-10-26T00:00:00Z",
                                bufferDays: 4,
                                reason: "NON_REFUNDABLE_PLATFORM_BUFFER",
                              }
                            hoursUntilSupplierDeadline: 720
                            refundable: false
                            supplierDeadlineUtc: null
                            platformCutoffUtc: "2025-10-26T00:00:00Z"
                            safeToBook: false
                            bufferDays: 4
                          searchCode: "24912730/911582482037300049/114"
                          category: 4
                          roomName: "Standard Room Double"
                          roomNames:
                            ["Standard Room Double", "Standard Room Single"]
                          roomsCount: 2
                          offerProof: "eyJhbGciOi..."
                        offersPreview:
                          - price: { amount: 575, currency: "USD" }
                            board: "BB"
                            refundable: true
                            cxlDeadline: "2025-10-30"
                            cancellation:
                              supplier: { refundable: true, deadlineUtc: null }
                              platform:
                                {
                                  refundable: false,
                                  cutoffUtc: "2025-10-26T00:00:00Z",
                                  bufferDays: 4,
                                  reason: "NON_REFUNDABLE_PLATFORM_BUFFER",
                                }
                              hoursUntilSupplierDeadline: null
                              refundable: false
                              supplierDeadlineUtc: null
                              platformCutoffUtc: "2025-10-26T00:00:00Z"
                              safeToBook: false
                              bufferDays: 4
                            searchCode: "24912730/911582482037300049/114"
                            category: 4
                            roomName: "Standard Room Double"
                            roomNames:
                              ["Standard Room Double", "Standard Room Single"]
                            roomsCount: 2
                            offerProof: "eyJhbGciOi..."
                        minPrice: { amount: 592.25, currency: "USD" }
                        hotelInfo:
                          descriptionHtml: "<p>...</p>"
                          facilitiesHtml: "<ul>...</ul>"
                          roomFacilitiesHtml: "<ul>...</ul>"

        "4XX":
          description: Error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              examples:
                missingParam:
                  value:
                    code: "MISSING_PARAM"
                    message: "cityId, arrivalDate, nights are required"
                    hint: "Provide ?cityId=...&arrivalDate=...&nights=..."

  /suppliers/goglobal/hotel-availability:
    get:
      tags: [Suppliers/GoGlobal]
      summary: Single-hotel availability (fast) for a given HotelId + search context
      operationId: goglobalHotelAvailability
      parameters:
        - in: query
          name: cityId
          required: true
          schema: { type: string }
        - in: query
          name: hotelId
          required: true
          schema: { type: string }
        - in: query
          name: arrivalDate
          required: true
          schema: { type: string, example: "2025-11-11" }
        - in: query
          name: nights
          required: true
          schema: { type: integer, example: 3, minimum: 1 }
        - in: query
          name: rooms
          required: false
          schema: { type: string, example: "1" }
        - in: query
          name: adults
          required: false
          schema: { type: string, example: "2" }
        - in: query
          name: children
          required: false
          schema: { type: string, example: "0" }
        - in: query
          name: childrenAges
          required: false
          schema: { type: string, example: "" }
          description: Comma-separated ages or per-room groups like "5|9,11"
        - in: query
          name: filterBasis
          required: false
          schema: { type: string, example: "BB,HB" }
          description: CSV of room basises (e.g. BB,HB)
        - in: query
          name: maximumWaitTime
          required: false
          schema: { type: integer, example: 15 }
        - in: query
          name: maxOffers
          required: false
          schema: { type: integer, example: 8 }
        - in: header
          name: X-Debug-Role
          required: false
          schema:
            type: string
            enum: [guest, b2c, office_user, b2b_sales_partner]
          description: Debug only. Overrides req.user.role for pricing.
        - in: header
          name: X-Debug-Markup
          required: false
          schema: { type: number, minimum: 0, maximum: 100 }
          description: Debug only. Used when X-Debug-Role=b2b_sales_partner to set a custom markup %.
      responses:
        "200":
          description: Single hotel with role-aware retail preview per offer
          content:
            application/json:
              schema:
                type: object
                properties:
                  hotel:
                    $ref: "#/components/schemas/HotelSingle"
                  meta:
                    type: object
                    properties:
                      provider: { type: string, example: goglobal }
                      found: { type: boolean, example: true }
                      roleMarkupPct:
                        type: number
                        nullable: true
                        description: Office-only (debug)
              examples:
                sample:
                  value:
                    hotel:
                      hotelId: "875154"
                      name: "HOLIDAY INN DUBAI AL-MAKTOUM AIRPORT"
                      category: 4
                      address: "NEAR AIRPORT"
                      city: "Dubai"
                      country: "United Arab Emirates"
                      image: "https://i.travelapi.com/lodging/..."
                      minRetail: { amount: 216.3, currency: "USD" }
                      offers:
                        - roomName: "STANDARD ROOM + STANDARD ROOM"
                          roomNames: ["STANDARD ROOM", "STANDARD ROOM"]
                          roomsCount: 2
                          board: "Room Only"
                          category: 4
                          price: null
                          retail: { amount: 210, currency: "USD" }
                          refundable: true
                          cxlDeadline: "01/Nov/2025"
                          cancellation:
                            supplier: { refundable: true, deadlineUtc: null }
                            platform:
                              {
                                refundable: true,
                                cutoffUtc: "2025-10-28T20:00:00Z",
                                bufferDays: 4,
                              }
                            hoursUntilSupplierDeadline: null
                            refundable: true
                            supplierDeadlineUtc: null
                            platformCutoffUtc: "2025-10-28T20:00:00Z"
                            safeToBook: true
                            bufferDays: 4
                          searchCode: "14995767/8116974349427911125/21022"
                          offerProof: "eyJhbGciOi..."
                        - roomName: "STANDARD ROOM + DELUXE ROOM"
                          roomNames: ["STANDARD ROOM", "DELUXE ROOM"]
                          roomsCount: 2
                          board: "Bed & Breakfast"
                          category: 4
                          price: null
                          retail: { amount: 262, currency: "USD" }
                          refundable: true
                          cxlDeadline: "01/Nov/2025"
                          cancellation:
                            supplier: { refundable: true, deadlineUtc: null }
                            platform:
                              {
                                refundable: true,
                                cutoffUtc: "2025-10-28T20:00:00Z",
                                bufferDays: 4,
                              }
                          searchCode: "14995767/8116974349427911125/21021"
                          offerProof: "eyJhbGciOi..."
                    meta:
                      provider: "goglobal"
                      found: true

  /suppliers/goglobal/valuation:
    get:
      tags: [Suppliers/GoGlobal]
      summary: Booking Valuation (GoGlobal OT=9)
      description: >
        Confirms price & cancellation right before booking. We do **not** force Currency;
        supplier default is used. Response shows both *supplier* and *platform* cancellation views
        (platform adds a safety buffer of N days).
      operationId: goglobalValuation
      security:
        - XDebugRole: []
        - XDebugMarkup: []
        - XOfferProof: []
      parameters:
        - in: query
          name: hotelSearchCode
          required: true
          schema:
            type: string
            pattern: ".+/.+"
          example: "25197606/5494176032190393843/13613"
          description: Copy from availability -> offers[].searchCode. NOT the hotelId/code.
        - in: query
          name: arrivalDate
          required: false
          schema: { type: string, format: date }
          description: Optional, improves accuracy for some suppliers
        - in: query
          name: offerProof
          required: false
          schema: { type: string }
          example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
          description: >
            Signed token from Availability. If provided, backend can price even if supplier returns empty <Rates/>.
            If both header and query are present, query is used.
        - in: header
          name: X-Offer-Proof
          required: false
          schema: { type: string }
          description: Same as offerProof query parameter.
        - in: query
          name: originalAmount
          required: false
          schema: { type: number, format: float, example: 169.00 }
          description: |
            Supplier price amount from Availability. Not sent to supplier; used by our backend when <Rates/> is empty (office fallback).
        - in: query
          name: originalCurrency
          required: false
          schema:
            type: string
            pattern: "^[A-Z]{3}$"
            example: USD
          description: Supplier price currency from Availability (ISO 4217).
        - in: header
          name: X-Debug-Role
          required: false
          schema:
            type: string
            enum: [guest, b2c, office_user, b2b_sales_partner]
          description: Debug only. Overrides req.user.role for pricing.
        - in: header
          name: X-Debug-Markup
          required: false
          schema: { type: number, minimum: 0, maximum: 100 }
          description: Debug only. Used when X-Debug-Role=b2b_sales_partner to set a custom markup %.
      responses:
        "200":
          description: Valuation with supplier/platform cancellation
          content:
            application/json:
              schema:
                type: object
                properties:
                  valuation:
                    $ref: "#/components/schemas/Valuation"
                  meta:
                    type: object
                    properties:
                      provider: { type: string, example: goglobal }
                      roleMarkupPct: { type: number }
                      safety:
                        type: object
                        properties:
                          bufferDays: { type: integer, example: 4 }
              examples:
                sample:
                  value:
                    valuation:
                      price: { amount: 303.48, currency: "EUR" }
                      supplierPrice: { amount: 281.00, currency: "EUR" }
                      cancellation:
                        supplier:
                          refundable: true
                          deadlineUtc: "2025-09-03T20:00:00Z"
                        platform:
                          refundable: false
                          cutoffUtc: "2025-08-30T20:00:00Z"
                          bufferDays: 4
                          reason: "NON_REFUNDABLE_PLATFORM_BUFFER"
                        hoursUntilSupplierDeadline: 39
                      remarks: "City tax payable at hotel."
                      remarksAnnotatedHtml: "<p><strong>Platform policy:</strong> ...</p>"
                    meta:
                      provider: "goglobal"
                      roleMarkupPct: 8
                      safety: { bufferDays: 4 }
        "401":
          description: Offer proof required / invalid
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                required:
                  value:
                    code: "PROOF_REQUIRED"
                    message: "offerProof is required. Request valuation only for an offer returned by Availability."
                    hint: "Call Availability, take offers[i].offerProof and pass it as ?offerProof=... or X-Offer-Proof header."
                invalid:
                  value:
                    code: "INVALID_OFFER_PROOF"
                    message: "Offer proof is invalid or expired."
        "409":
          description: Supplier session not found (rate expired)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                sessionExpired:
                  value:
                    message: "Supplier session not found"
                    hint: "Please refresh availability and retry valuation within the same session."
                    code: 315
        "424":
          description: Supplier returned no price; use original amount/currency or stored offer
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
              examples:
                noPrice:
                  value:
                    message: "Supplier valuation unavailable"
                    code: "NO_PRICE"
                    hint: "Refresh availability (and pass offerProof) and retry."

    post:
      tags: [Suppliers/GoGlobal]
      summary: Booking Valuation (POST)
      operationId: goglobalValuationPost
      security:
        - XDebugRole: []
        - XDebugMarkup: []
        - XOfferProof: []
      parameters:
        - in: header
          name: X-Debug-Role
          required: false
          schema:
            type: string
            enum: [guest, b2c, office_user, b2b_sales_partner]
          description: Debug only. Overrides req.user.role for pricing.
        - in: header
          name: X-Debug-Markup
          required: false
          schema: { type: number, minimum: 0, maximum: 100 }
          description: Debug only. Used when X-Debug-Role=b2b_sales_partner to set a custom markup %.
        - in: header
          name: X-Offer-Proof
          required: false
          schema: { type: string }
          description: Same as offerProof in request body. Body has priority over header.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [hotelSearchCode]
              properties:
                hotelSearchCode:
                  type: string
                  pattern: ".+/.+"
                  example: "25197606/5494176032190393843/13613"
                arrivalDate: { type: string, format: date }
                offerProof:
                  type: string
                  description: >
                    Signed token from Availability. If present, originalAmount/originalCurrency are not needed.
                  example: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
                originalAmount: { type: number, format: float, example: 169.00 }
                originalCurrency:
                  type: string
                  pattern: "^[A-Z]{3}$"
                  example: USD
      responses:
        "200":
          $ref: "#/paths/~1suppliers~1goglobal~1valuation/get/responses/200"
        "401":
          $ref: "#/paths/~1suppliers~1goglobal~1valuation/get/responses/401"
        "409":
          $ref: "#/paths/~1suppliers~1goglobal~1valuation/get/responses/409"
        "424":
          $ref: "#/paths/~1suppliers~1goglobal~1valuation/get/responses/424"

  /suppliers/goglobal/hotel-info:
    get:
      tags: [Suppliers/GoGlobal]
      summary: Hotel Info (descriptions, facilities, pictures)
      operationId: goglobalHotelInfo
      parameters:
        - in: query
          name: hotelId
          required: true
          schema: { type: string }
          description: Supplier hotel code from availability (e.g. hotels[i].externalSource.hotelCode)
        - in: query
          name: lang
          required: false
          schema: { type: string, default: en }
          description: Info language (e.g. en)
      responses:
        "200":
          description: Slim hotel info payload
          content:
            application/json:
              schema:
                type: object
                properties:
                  hotel:
                    $ref: "#/components/schemas/HotelInfoSlim"
                  meta:
                    type: object
                    properties:
                      provider: { type: string, example: goglobal }

  /suppliers/goglobal/booking/create:
    post:
      tags: [Suppliers/GoGlobal]
      summary: Booking Create (BOOKING_INSERT_REQUEST)
      operationId: goglobalBookingCreate
      security:
        - XDebugRole: []
        - XDebugMarkup: []
        - XOfferProof: []
      parameters:
        - in: header
          name: X-Debug-Role
          required: false
          schema:
            type: string
            enum: [guest, b2c, office_user, b2b_sales_partner]
          description: Debug only. Overrides req.user.role for pricing.
        - in: header
          name: X-Debug-Markup
          required: false
          schema: { type: number, minimum: 0, maximum: 100 }
          description: Debug only. Used when X-Debug-Role=b2b_sales_partner to set a custom markup %.
      description: >
        Ստեղծում է ամրագրում GoGlobal-ում՝ multi-room pax-ով (ADT/CHD). Controller-ը ընդունում է
        ինչպես `pax[]` (roomId + persons[]), այնպես էլ `rooms[]` (adults + pax[])՝ ներքին coerces-ով։
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BookRequest'
            examples:
              multiRoom:
                value:
                  hotelSearchCode: "26106591/307591388318987654/6"
                  arrivalDate: "2025-12-13"
                  nights: 2
                  noAlternativeHotel: true
                  agentReference: "inLobby Test"
                  pax:
                    - roomId: 1
                      persons:
                        - { type: ADT, title: "MR.",  firstName: "Arman", lastName: "Mnatsakanyan" }
                        - { type: ADT, title: "MRS.", firstName: "Anna",  lastName: "Grigoryan" }
                        - { type: CHD,              firstName: "Andranik", lastName: "Mnatsakanyan", age: 10 }
                        - { type: CHD,              firstName: "Gevorg",   lastName: "Mnatsakanyan", age: 5 }
                  notes: "Late arrival ~23:00"
                  payment: { method: "NONE" }
      responses:
        "200":
          description: Booking created (retail + supplier cancellation policy redacted/public)
          content:
            application/json:
              schema:
                type: object
                properties:
                  booking: { type: object }
                  meta: { type: object }
              examples:
                ok:
                  value:
                    booking:
                      goBookingCode: "33456"
                      goReference: "GO95345-33456-A(IR)"
                      status: "C"
                      price: { amount: 1042.00, currency: "EUR" }
                      hotel: { id: "875154", name: "HOLIDAY INN DUBAI AL-MAKTOUM AIRPORT" }
                      context:
                        hotelSearchCode: "26106591/307591388318987654/6"
                        arrivalDate: "2025-12-13"
                        nights: 2
                        roomBasis: "Bed & Breakfast"
                      rooms:
                        - { roomId: 1, adults: 2, pax: [ {type: "adult"}, {type: "adult"}, {type:"child"}, {type:"child"} ] }
                      cancellation:
                        platform: { refundable: true, cutoffUtc: "2025-12-09T20:00:00Z", bufferDays: 4 }
                    meta:
                      provider: "goglobal"
                      roleMarkupPct: 8
        "4XX":
          description: Error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /suppliers/goglobal/booking/details:
    get:
      tags: [Suppliers/GoGlobal]
      summary: Booking Details (BOOKING_DETAILS_REQUEST)
      operationId: goglobalBookingDetails
      security:
        - XDebugRole: []
        - XDebugMarkup: []
        - XOfferProof: []
      parameters:
        - in: header
          name: X-Debug-Role
          required: false
          schema:
            type: string
            enum: [guest, b2c, office_user, b2b_sales_partner]
          description: Debug only. Overrides req.user.role for pricing.
        - in: header
          name: X-Debug-Markup
          required: false
          schema: { type: number, minimum: 0, maximum: 100 }
          description: Debug only. Used when X-Debug-Role=b2b_sales_partner to set a custom markup %.
        - $ref: '#/components/parameters/GoBookingCodeQuery'
      responses:
        "200":
          description: Full booking data (retail preview, platform cxl-view)
          content:
            application/json:
              schema:
                type: object
                properties:
                  booking: { type: object }
                  meta: { type: object }
              examples:
                ok:
                  value:
                    booking:
                      goBookingCode: "33456"
                      goReference: "GO95345-33456-A(IR)"
                      status: "C"
                      price: { amount: 1042.00, currency: "EUR" }
                      hotel: { id: "875154", name: "AC" }
                      context:
                        hotelSearchCode: "26106591/307591388318987654/6"
                        arrivalDate: "2025-12-13"
                        nights: 2
                        roomBasis: "RO"
                      rooms:
                        - roomId: 1
                          pax:
                            - { type: ADT, title: "MR.",  firstName: "ARMAN", lastName: "MNATSAKANYAN" }
                            - { type: ADT, title: "MRS.", firstName: "ANNA",  lastName: "GRIGORYAN" }
                            - { type: CHD, firstName: "ANDRANIK", lastName: "MNATSAKANYAN", age: 10 }
                            - { type: CHD, firstName: "GEVORG",   lastName: "MNATSAKANYAN", age: 5 }
                      cancellation:
                        platform: { refundable: true, cutoffUtc: "2025-12-09T20:00:00Z", bufferDays: 4 }
                    meta:
                      provider: "goglobal"
                      roleMarkupPct: 8
        "4XX":
          description: Error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /suppliers/goglobal/booking/status:
    get:
      tags: [Suppliers/GoGlobal]
      summary: Booking Status (BOOKING_STATUS_REQUEST)
      operationId: goglobalBookingStatus
      security:
        - XDebugRole: []
        - XDebugMarkup: []
        - XOfferProof: []
      parameters:
        - in: header
          name: X-Debug-Role
          required: false
          schema:
            type: string
            enum: [guest, b2c, office_user, b2b_sales_partner]
          description: Debug only. Overrides req.user.role for pricing.
        - in: header
          name: X-Debug-Markup
          required: false
          schema: { type: number, minimum: 0, maximum: 100 }
          description: Debug only. Used when X-Debug-Role=b2b_sales_partner to set a custom markup %.
        - $ref: '#/components/parameters/GoBookingCodeQuery'
      responses:
        "200":
          description: Current supplier status + retail preview
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: object }
                  meta: { type: object }
              examples:
                ok:
                  value:
                    status:
                      goBookingCode: "33456"
                      goReference: "GO95345-33456-A(IR)"
                      status: "C"   # e.g. C / X / RX / RQ ...
                      price: { amount: 1042.00, currency: "EUR" }
                    meta:
                      provider: "goglobal"
                      roleMarkupPct: 8
        "4XX":
          description: Error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }

  /suppliers/goglobal/booking/cancel:
    post:
      tags: [Suppliers/GoGlobal]
      summary: Booking Cancel (BOOKING_CANCEL_REQUEST)
      operationId: goglobalBookingCancel
      description: >
        Ուղարկում է supplier cancel խնդրանք՝ տրված goBookingCode-ով։
        Վերադարձնում է supplier-ի crude status-ը (X/RX/...), refunds/penalty–ների հաշվարկը
        կատարվում է platform մակարդակով՝ այլ endpoint-ներում։
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [goBookingCode]
              properties:
                goBookingCode: { type: string }
                reason: { type: string, nullable: true }
            examples:
              sample:
                value:
                  goBookingCode: "33456"
                  reason: "Client requested cancellation"
      responses:
        "200":
          description: Cancel response
          content:
            application/json:
              schema:
                type: object
                properties:
                  cancel:
                    type: object
                    properties:
                      goBookingCode: { type: string }
                      status:
                        type: string
                        description: Supplier status (e.g., X, RX, C, RJ, VCH, VRQ…)
                  meta: { type: object }
              examples:
                ok:
                  value:
                    cancel: { goBookingCode: "33456", status: "RX" }
                    meta: { provider: "goglobal" }
        "4XX":
          description: Error
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ErrorResponse' }
  
  /hotel-orders/orders/hotel:
    get:
      tags: [Orders/Hotel]
      summary: List my hotel orders (office/admin/finance see all)
      operationId: listHotelOrders
      security:
        - XDebugRole: []
      parameters:
        - in: query
          name: page
          schema: { type: integer, minimum: 1, default: 1 }
          description: Page number (1-based)
        - in: query
          name: limit
          schema: { type: integer, minimum: 1, maximum: 200, default: 20 }
          description: Items per page
        - in: query
          name: status
          schema:
            $ref: "#/components/schemas/HotelOrderPlatformStatus"
          description: Platform status filter (e.g. CONFIRMED, REQUESTED, ...)
        - in: query
          name: rawStatus
          schema:
            $ref: "#/components/schemas/HotelOrderSupplierStatus"
          description: Supplier raw status filter (C/RQ/RJ/RX/X/VCH/VRQ)
        - in: query
          name: role
          schema:
            type: string
            enum: [b2c, b2b_sales_partner, office_user, admin, finance]
          description: Filter by buyer role (office/admin/finance only)
        - in: query
          name: from
          schema: { type: string, format: date-time }
          description: Created-at >= from (ISO)
        - in: query
          name: to
          schema: { type: string, format: date-time }
          description: Created-at <= to (ISO)
        - in: query
          name: q
          schema: { type: string }
          description: Free text search (platformRef, agentRef, email, hotel/city)
      responses:
        "200":
          description: Paged list of orders (fields are role–aware by ACL)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HotelOrderSummaryPage"
              examples:
                ok:
                  value:
                    page: 1
                    limit: 20
                    total: 2
                    items:
                      - platformRef: "IL-H-20251019-74FD09"
                        status: "CONFIRMED"
                        role: "b2c"
                        summary:
                          agentRef: "inLobby Test"
                          agency: null
                          userEmail: "anna@example.com"
                          city: "Dubai"
                          service: "RAMEE ROSE"
                          rooms: 1
                          leadName: "ARMAN MNATSAKANYAN"
                          arrivalDate: "2025-12-13"
                          nights: 3
                          cancellation: { refundable: true, platformCutoffUtc: "2025-12-06T00:00:00.000Z" }
                          price: { amount: 246.17, currency: "USD" }
                          sellingPrice: { amount: 246.17, currency: "USD" }
                          paid: false
                      - platformRef: "IL-H-20251018-EBB05D"
                        status: "CONFIRMED"
                        role: "b2b_sales_partner"
                        summary:
                          agentRef: "Call-#4382 / Anna"
                          agency: "ACME Travel"
                          userEmail: "agent@acme.tld"
                          city: "Dubai"
                          service: "QUEEN ELIZABETH 2"
                          rooms: 1
                          leadName: "ARMAN MNATSAKANYAN"
                          arrivalDate: "2025-12-13"
                          nights: 3
                          cancellation: { refundable: true, platformCutoffUtc: "2025-12-06T00:00:00.000Z" }
                          price: { amount: 352.26, currency: "USD" }
                          sellingPrice: { amount: 352.26, currency: "USD" }
                          paid: false
        "401":
          description: Unauthorized (login required or X-Debug-Role missing)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Forbidden (insufficient privileges)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /hotel-orders/orders/hotel/{platformRef}:
    get:
      tags: [Orders/Hotel]
      summary: Get order details by platformRef
      operationId: getHotelOrder
      security:
        - XDebugRole: []
      parameters:
        - in: path
          name: platformRef
          required: true
          schema: { type: string }
          description: The platform reference (e.g. IL-H-YYYYMMDD-XXXXXX)
      responses:
        "200":
          description: Full order details (supplier fields are hidden for non-office roles)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/HotelOrderDetailResponse"
              examples:
                ok:
                  value:
                    order:
                      platformRef: "IL-H-20251019-74FD09"
                      status: "CONFIRMED"
                      role: "b2c"
                      summary:
                        agentRef: "inLobby Test"
                        agency: null
                        userEmail: "anna@example.com"
                        city: "Dubai"
                        service: "RAMEE ROSE"
                        rooms: 1
                        leadName: "ARMAN MNATSAKANYAN"
                        arrivalDate: "2025-12-13"
                        nights: 3
                        cancellation: { refundable: true, platformCutoffUtc: "2025-12-06T00:00:00.000Z" }
                        price: { amount: 246.17, currency: "USD" }
                        sellingPrice: { amount: 246.17, currency: "USD" }
                        paid: false
                      details:
                        hotel:
                          id: "64081"
                          name: "RAMEE ROSE"
                          category: 4
                          address: "Tecom, Dubai"
                          city: "Dubai"
                          country: "United Arab Emirates"
                          image: "https://..."
                        context:
                          hotelSearchCode: "25236127/8511033934022985655/4"
                          arrivalDate: "2025-12-13"
                          nights: 3
                          roomBasis: "Room Only"
                        rooms:
                          - roomId: 1
                            category: "Standard Room"
                            pax:
                              - { type: "ADT", title: "MR.", firstName: "ARMAN", lastName: "MNATSAKANYAN" }
                              - { type: "ADT", title: "MRS.", firstName: "ANNA",  lastName: "GRIGORYAN" }
                        cancellation:
                          platform: { refundable: true, cutoffUtc: "2025-12-06T00:00:00.000Z", bufferDays: 4 }
                          supplier: { refundable: true, deadlineUtc: null }
                          safeToBook: true
                          bufferDays: 4
                        remarksHtml: "<BR />A tax is imposed by the city..."
                        price:
                          retail: { amount: 246.17, currency: "USD" }
                          net: { amount: 239, currency: "USD" }
                      payment:
                        status: "unpaid"
                        method: "none"
                        provider: null
                        history: []
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found

  /hotel-orders/orders/hotel/{platformRef}/agent-ref:
    patch:
      tags: [Orders/Hotel]
      summary: Update Agent Reference (internal note field)
      operationId: patchAgentRef
      security:
        - XDebugRole: []
      parameters:
        - in: path
          name: platformRef
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [agentRef]
              properties:
                agentRef:
                  type: string
                  maxLength: 120
                  description: Free text internal reference
            examples:
              ex:
                value: { agentRef: "Call-#4382 / Anna" }
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok: { type: boolean }
                  agentRef: { type: string }
                required: [ok, agentRef]
              examples:
                ok:
                  value: { ok: true, agentRef: "Call-#4382 / Anna" }
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Not found

  /suppliers/goglobal/booking/{platformRef}/status-sync:
    get:
      tags: [Suppliers/GoGlobal]
      summary: Sync supplier status by platformRef (updates order + history)
      operationId: goglobalStatusSyncByPlatformRef
      security:
        - XDebugRole: []   # թողնում ենք swagger-ով փորձարկման համար
      parameters:
        - in: path
          name: platformRef
          required: true
          schema: { type: string }
          description: Platform reference (e.g. IL-H-20251019-74FD09)
        - in: query
          name: debug
          schema: { type: integer, enum: [0,1], default: 0 }
          description: Optional debug preview for supplier raw payload
      responses:
        "200":
          description: Sync result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GoGlobalStatusSyncResponse"
              examples:
                ok:
                  value:
                    ok: true
                    platformRef: "IL-H-20251019-74FD09"
                    supplierRaw: "X"
                    status: "X"
                    statusLabel: "Cancelled"
                    changed: true
                    prev: { raw: "C", status: "C", statusLabel: "Confirmed" }
                    next: { raw: "X", status: "X", statusLabel: "Cancelled" }
        "404":
          description: Order not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /suppliers/goglobal/booking/{platformRef}/cancel:
    post:
      tags: [Suppliers/GoGlobal]
      summary: Cancel booking by platformRef (persists supplier status to order)
      operationId: goglobalCancelByPlatformRef
      security:
        - XDebugRole: []
      parameters:
        - in: path
          name: platformRef
          required: true
          schema: { type: string }
          description: Platform reference (e.g. IL-H-20251019-74FD09)
      requestBody:
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Optional free-text reason (stored in history)
      responses:
        "200":
          description: Cancel result
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/GoGlobalCancelByPlatformRefResponse"
              examples:
                ok:
                  value:
                    ok: true
                    platformRef: "IL-H-20251019-74FD09"
                    accepted: true
                    supplierRaw: "X"
                    status: "X"
                    statusLabel: "Cancelled"
                    prev: { raw: "X", status: "X", statusLabel: "Cancelled" }
                    next: { raw: "X", status: "X", statusLabel: "Cancelled" }
        "404":
          description: Order not found
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
  
components:
  securitySchemes:
    XDebugRole:
      type: apiKey
      in: header
      name: X-Debug-Role
    XDebugMarkup:
      type: apiKey
      in: header
      name: X-Debug-Markup
    XOfferProof:
      type: apiKey
      in: header
      name: X-Offer-Proof
      description: >
        Signed token from Availability (offerProof). If present, Valuation can succeed even when supplier
        omits <Rates/>. Body/query take precedence over this header.
  parameters:
    BookingIdParam:
      name: id
      in: path
      required: true
      schema: { type: string }
      description: Platform booking ID (Mongo ObjectId or ULID)
    
    GoBookingCodeQuery:
      name: goBookingCode
      in: query
      required: true
      schema: { type: string }
      description: Supplier booking code returned by BOOKING_INSERT / BOOKING_SEARCH

  schemas:
    Money:
      type: object
      properties:
        amount:
          type: number
        currency:
          type: string
          description: ISO 4217 (supplier-returned)
          example: EUR

    Image:
      type: object
      properties:
        url: { type: string }
        isMain: { type: boolean }

    # ─────────── Hotel info (supplier-side) ───────────
    HotelInfoSlim:
      type: object
      properties:
        hotelId: { type: string }
        name: { type: string, nullable: true }
        address: { type: string, nullable: true }
        cityId: { type: string, nullable: true }
        category: { type: integer, nullable: true }
        descriptionHtml: { type: string, nullable: true }
        facilitiesHtml: { type: string, nullable: true }
        roomFacilitiesHtml: { type: string, nullable: true }
        facilities:
          type: array
          items: { type: string }
        roomFacilities:
          type: array
          items: { type: string }
        checkinTime: { type: string, nullable: true }
        checkoutTime: { type: string, nullable: true }
        pictures:
          type: array
          items:
            $ref: "#/components/schemas/Image"

    # 🔼 USED IN MULTI-HOTEL AVAILABILITY & HOTEL PAGE OFFERS
    OfferLite:
      type: object
      properties:
        price:
          allOf: [{ $ref: "#/components/schemas/Money" }]
          nullable: true
          description: Supplier NET; may be null for public roles.
        retail:
          allOf: [{ $ref: "#/components/schemas/Money" }]
          nullable: true
          description: Retail (NET + role markup). Present when backend can compute it.
        retailBreakdown:
          type: object
          nullable: true
          properties:
            net: { $ref: "#/components/schemas/Money" }
            markupPct: { type: number }
            markupAmount: { type: number }
        board:
          type: string
          example: BB
        refundable:
          type: boolean
          description: Legacy flat flag (supplier)
        cxlDeadline:
          type: string
          nullable: true
          description: Supplier deadline as date string (original)
        cancellation:
          $ref: "#/components/schemas/CancellationV2"
        searchCode:
          type: string
          description: GoGlobal rate key (copy to valuation)
          example: "25197606/5494176032190393843/13613"
        category:
          type: integer
        roomName:
          type: string
          nullable: true
          description: First room name for backward compatibility.
        roomNames:
          type: array
          items: { type: string }
          description: Per-room names returned by supplier for this multi-room offer.
        roomsCount:
          type: integer
          nullable: true
          description: Number of rooms in this offer (derived from roomNames length).
        offerProof:
          type: string
          description: Signed token (use in valuation as ?offerProof= or X-Offer-Proof)

    # 🔼 USED IN MULTI-HOTEL AVAILABILITY
    Hotel:
      type: object
      properties:
        _id:
          type: string
          description: Provider hotel code (string)
        name:
          type: string
        stars:
          type: integer
        thumbnail:
          type: string
          nullable: true
        images:
          type: array
          items: { $ref: "#/components/schemas/Image" }
        rating:
          type: number
        reviewsCount:
          type: integer
        externalRating:
          type: number
          nullable: true
        location:
          type: object
          properties:
            city: { type: string, nullable: true }
            country: { type: string, nullable: true }
            address: { type: string, nullable: true }
            lat: { type: number, nullable: true }
            lng: { type: number, nullable: true }
        externalSource:
          type: object
          properties:
            provider: { type: string, example: goglobal }
            hotelCode: { type: string }
            cityId: { type: string }
        minOffer:
          $ref: "#/components/schemas/OfferLite"
        offersPreview:
          type: array
          items:
            $ref: "#/components/schemas/OfferLite"
        minPrice:
          $ref: "#/components/schemas/Money"
        hotelInfo:
          $ref: "#/components/schemas/HotelInfoSlim"

    # 🔼 USED IN SINGLE-HOTEL AVAILABILITY
    HotelSingle:
      type: object
      properties:
        hotelId: { type: string }
        name: { type: string, nullable: true }
        category: { type: integer, nullable: true }
        address: { type: string, nullable: true }
        city: { type: string, nullable: true }
        country: { type: string, nullable: true }
        image: { type: string, nullable: true }
        minRetail:
          allOf:
            - $ref: "#/components/schemas/Money"
          nullable: true
        offers:
          type: array
          items: { $ref: "#/components/schemas/OfferLite" }

    Valuation:
      type: object
      properties:
        price:
          $ref: "#/components/schemas/Money"
        supplierPrice:
          $ref: "#/components/schemas/Money"
        cancellation:
          $ref: "#/components/schemas/CancellationV2"
        remarks:
          type: string
        remarksAnnotatedHtml:
          type: string
          description: Platform-first note (cutoff or non-refundable) prepended to supplier remarks (HTML).
        breakdown:
          type: object
          properties:
            supplierBase: { $ref: "#/components/schemas/Money" }
            markup: { $ref: "#/components/schemas/Money" }
            total: { $ref: "#/components/schemas/Money" }
            supplierBaseAmd: { type: number, nullable: true }
            markupAmd: { type: number, nullable: true }
            totalAmd: { type: number, nullable: true }
            exchange:
              type: object
              properties:
                base: { type: string, example: AMD }
                usedRateFor: { type: string, example: USD }
                rate: { type: number, example: 387.5, nullable: true }
                lastUpdatedAt:
                  { type: string, format: date-time, nullable: true }
            taxesAndFees:
              type: object
              properties:
                payAtHotelNote: { type: string, nullable: true }

    CancellationV2:
      type: object
      properties:
        supplier:
          type: object
          properties:
            refundable: { type: boolean, nullable: true }
            deadlineUtc: { type: string, format: date-time, nullable: true }
        platform:
          type: object
          properties:
            refundable: { type: boolean, nullable: true }
            cutoffUtc: { type: string, format: date-time, nullable: true }
            bufferDays: { type: integer, nullable: true }
            reason:
              type: string
              enum:
                [
                  NON_REFUNDABLE_SUPPLIER,
                  NON_REFUNDABLE_PLATFORM_BUFFER,
                  NO_DEADLINE,
                ]
              nullable: true
        hoursUntilSupplierDeadline:
          type: integer
          nullable: true
        refundable: { type: boolean, nullable: true }
        supplierDeadlineUtc: { type: string, format: date-time, nullable: true }
        platformCutoffUtc: { type: string, format: date-time, nullable: true }
        safeToBook: { type: boolean, nullable: true }
        bufferDays: { type: integer, nullable: true }

    ErrorResponse:
      type: object
      properties:
        code: { type: string }
        message: { type: string }
        hint: { type: string }
        context: { type: object }

    # ─────────── Pax / Booking DTOs (kept as-is) ───────────
    PaxPerson:
      type: object
      required: [type, firstName, lastName]
      properties:
        type:
          type: string
          enum: [ADT, CHD]
          description: ADT=adult, CHD=child
        title:
          type: string
          nullable: true
          description: >
            Adults only. Case-sensitive: MR. / MRS. / MISS / MS.
            If omitted or invalid, backend maps to MR.
          enum: ["MR.", "MRS.", "MISS", "MS"]
        firstName:
          type: string
          pattern: "^[A-Za-z][A-Za-z .'-]*$"
          description: Non-unicode only; must start with a letter.
        lastName:
          type: string
          minLength: 2
          pattern: "^[A-Za-z]{2}[A-Za-z .'-]*$"
          description: Non-unicode only; must start with 2 letters.
        age:
          type: integer
          minimum: 0
          maximum: 18
          nullable: true
          description: Required when type=CHD; ignored for ADT.

    RoomPaxGroup:
      type: object
      required: [roomId, persons]
      properties:
        roomId:
          type: integer
          minimum: 1
        persons:
          type: array
          minItems: 1
          maxItems: 8
          items: { $ref: "#/components/schemas/PaxPerson" }
      description: >
        RESTRICTIONS ENFORCED BY BACKEND:
        • each room must have at least 1 adult;
        • total persons per room ≤ 8;
        • children per room ≤ 4 (type=CHD);
        • child ages 0–18;
        • titles only for adults and must be MR./MRS./MISS/MS.

    BookRequest:
      type: object
      required: [hotelSearchCode, arrivalDate, nights, pax, agentReference]
      properties:
        hotelSearchCode:
          type: string
          description: Offer rate key from availability/valuation (HotelSearchCode/searchCode).
          example: "25197606/5494176032190393843/13613"
        arrivalDate:
          type: string
          format: date
        nights:
          type: integer
          minimum: 1
        noAlternativeHotel:
          type: boolean
          default: true
        agentReference:
          type: string
          description: Your client reference (echoed back by supplier).
        notes:
          type: string
          nullable: true
        pax:
          type: array
          minItems: 1
          maxItems: 8
          description: Per-room traveller lists in room order.
          items: { $ref: "#/components/schemas/RoomPaxGroup" }
        payment:
          type: object
          nullable: true
          properties:
            method:
              type: string
              enum: [NONE, SUPPLIER_CC]
              default: NONE
            encryptedCard:
              type: string
              nullable: true
              description: RSA+base64 per supplier spec (when method=SUPPLIER_CC).

    BookResponse:
      type: object
      properties:
        status:
          type: string
          description: Supplier booking status (C, RQ, RJ, RX, X, VCH, VRQ…)
        goBookingCode:
          type: string
        goReference:
          type: string
        currency:
          type: string
        totalPrice:
          type: number
        cancellationDeadline:
          type: string
          format: date-time

    BookingDetails:
      type: object
      properties:
        goBookingCode: { type: string }
        bookingStatus: { type: string }
        hotelName: { type: string }
        hotelSearchCode: { type: string }
        arrivalDate: { type: string, format: date }
        nights: { type: integer }
        currency: { type: string }
        totalPrice: { type: number }
        rooms:
          type: array
          items:
            type: object
            properties:
              roomId: { type: integer }
              board: { type: string }
              pax:
                type: array
                items: { $ref: "#/components/schemas/PaxPerson" }

    BookingStatus:
      type: string
      enum: [waiting_approval, confirmed, cancelled, rejected_by_partner]

    PaymentStatus:
      type: string
      enum: [not_paid, paid_pending_verification, verified, refunded]

    MainOrderStatus:
      type: string
      enum:
        [
          awaiting_payment,
          awaiting_confirmation,
          confirmed,
          cancelled_by_user,
          cancelled_due_to_no_payment,
          rejected,
          refunded,
        ]

    PaymentMethod:
      type: string
      enum: [credit_card, balance, pay_later]

    ContactInfo:
      type: object
      properties:
        email: { type: string, format: email }
        phone: { type: string }
        address: { type: string, nullable: true }

    LeadGuest:
      type: object
      required: [firstName, lastName]
      properties:
        title:
          type: string
          nullable: true
          enum: ["MR.", "MRS.", "MISS", "MS"]
        firstName: { type: string }
        lastName: { type: string }
        email: { type: string, format: email }
        phone: { type: string }

    PlatformPaymentInput:
      type: object
      required: [method]
      properties:
        method:
          $ref: "#/components/schemas/PaymentMethod"
        cardToken:
          type: string
          nullable: true
        useBalanceIfSufficient:
          type: boolean
          default: false

    PlatformTotalsInput:
      type: object
      required: [currency, totalPrice]
      properties:
        currency:
          type: string
          description: ISO 4217 (e.g., EUR, USD, AMD)
        totalPrice:
          type: number
          description: >
            **Authoritative total** from valuation/offer (includes markup).
        breakdownNote:
          type: string
          nullable: true

    PlatformBookingCreateRequest:
      type: object
      required:
        - hotelSearchCode
        - arrivalDate
        - nights
        - pax
        - leadGuest
        - payment
        - totals
      properties:
        offerProof:
          type: string
          description: Signed token from Availability (recommended for safety)
        hotelSearchCode:
          type: string
          description: Offer rate key used for supplier booking/valuation
        hotelId:
          type: string
          description: Supplier hotel code (for traceability)
        cityId:
          type: string
          description: Supplier/internal city id (for traceability)
        arrivalDate:
          type: string
          format: date
        nights:
          type: integer
          minimum: 1
        nationality:
          type: string
          minLength: 2
          maxLength: 2
          example: AM
        leadGuest:
          $ref: "#/components/schemas/LeadGuest"
        contact:
          $ref: "#/components/schemas/ContactInfo"
        pax:
          type: array
          minItems: 1
          maxItems: 9
          description: Per-room pax groups. Room IDs should be 1..N in room order.
          items: { $ref: "#/components/schemas/RoomPaxGroup" }
        notes:
          type: string
          nullable: true
        payment:
          $ref: "#/components/schemas/PlatformPaymentInput"
        totals:
          $ref: "#/components/schemas/PlatformTotalsInput"

    PlatformPayment:
      type: object
      properties:
        method: { $ref: "#/components/schemas/PaymentMethod" }
        status: { $ref: "#/components/schemas/PaymentStatus" }
        amount:
          $ref: "#/components/schemas/Money"
        transactions:
          type: array
          items:
            type: object
            properties:
              id: { type: string }
              kind: { type: string, enum: [incoming, outgoing] }
              amount: { $ref: "#/components/schemas/Money" }
              createdAt: { type: string, format: date-time }
              note: { type: string, nullable: true }

    PlatformBooking:
      type: object
      properties:
        id: { type: string, description: "Platform booking id" }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
        supplier:
          type: object
          properties:
            provider: { type: string, example: goglobal }
            goBookingCode: { type: string, nullable: true }
            goReference: { type: string, nullable: true }
        context:
          type: object
          properties:
            hotelSearchCode: { type: string }
            offerProof: { type: string, nullable: true }
            hotelId: { type: string }
            cityId: { type: string }
            arrivalDate: { type: string, format: date }
            nights: { type: integer }
            nationality: { type: string }
        leadGuest:
          $ref: "#/components/schemas/LeadGuest"
        contact:
          $ref: "#/components/schemas/ContactInfo"
        pax:
          type: array
          items: { $ref: "#/components/schemas/RoomPaxGroup" }
        notes: { type: string, nullable: true }
        bookingStatus: { $ref: "#/components/schemas/BookingStatus" }
        payment:
          $ref: "#/components/schemas/PlatformPayment"
        mainStatus: { $ref: "#/components/schemas/MainOrderStatus" }
        totals:
          type: object
          properties:
            price: { $ref: "#/components/schemas/Money" }
            priceAmd: { type: number, nullable: true }
            exchange:
              type: object
              properties:
                base: { type: string, example: AMD }
                usedRateFor: { type: string, example: EUR }
                rate: { type: number, nullable: true }
                lastUpdatedAt: { type: string, format: date-time, nullable: true }

    PlatformBookingStatus:
      type: object
      properties:
        id: { type: string }
        bookingStatus: { $ref: "#/components/schemas/BookingStatus" }
        paymentStatus: { $ref: "#/components/schemas/PaymentStatus" }
        mainStatus: { $ref: "#/components/schemas/MainOrderStatus" }
        supplier:
          type: object
          properties:
            provider: { type: string, example: goglobal }
            goBookingCode: { type: string, nullable: true }
            rawSupplierStatus:
              {
                type: string,
                nullable: true,
                description: "e.g., C, RX, RJ, VRQ…",
              }
        updatedAt: { type: string, format: date-time }

    PlatformCancelRequest:
      type: object
      properties:
        reason:
          type: string
        refundProposal:
          type: object
          nullable: true
          properties:
            refundableAmount: { type: number }
            penaltyFee: { type: number }
            currency: { type: string }

    PlatformCancelResponse:
      type: object
      properties:
        id: { type: string }
        bookingStatus: { $ref: "#/components/schemas/BookingStatus" }
        paymentStatus: { $ref: "#/components/schemas/PaymentStatus" }
        mainStatus: { $ref: "#/components/schemas/MainOrderStatus" }
        supplier:
          type: object
          properties:
            provider: { type: string, example: goglobal }
            goBookingCode: { type: string, nullable: true }
            rawSupplierStatus: { type: string, nullable: true }
        note: { type: string, nullable: true }

    # ─────────── NEW: status enums & ops meta ───────────
    HotelOrderPlatformStatus:
      type: string
      enum:
        - CONFIRMED
        - REQUESTED
        - REJECTED
        - CANCELLING
        - CANCELLED
        - VOUCHER_ISSUED
        - VOUCHER_REQUESTED
        - PENDING
        - FAILED

    HotelOrderSupplierStatus:
      type: string
      enum: [C, RQ, RJ, RX, X, VCH, VRQ]

    HotelOrderOpsMeta:
      type: object
      properties:
        supplier: { type: string, example: goglobal }
        rawStatus:
          $ref: "#/components/schemas/HotelOrderSupplierStatus"
        rawStatusLabel: { type: string }
        supplierRef: { type: string, nullable: true }
        supplierBookingCode: { type: string, nullable: true }

    # ─────────── NEW: Orders list (flattened items) ───────────
    CancellationSummary:
      type: object
      properties:
        refundable: { type: boolean, nullable: true }
        platformCutoffUtc: { type: string, format: date-time, nullable: true }

    HotelOrderListItem:
      type: object
      properties:
        platformRef: { type: string }
        status:
          $ref: "#/components/schemas/HotelOrderPlatformStatus"
        statusLabel: { type: string }
        isPayable: { type: boolean }
        role: { type: string }
        agentRef: { type: string, nullable: true }
        agency: { type: string, nullable: true }
        user: { type: string, nullable: true }
        city: { type: string, nullable: true }
        service: { type: string, nullable: true }
        rooms: { type: integer }
        leadName: { type: string, nullable: true }
        arrivalDate: { type: string, format: date }
        nights: { type: integer }
        cancellation: { $ref: "#/components/schemas/CancellationSummary" }
        price: { $ref: "#/components/schemas/Money" }
        paid: { type: boolean }
        _ops:
          $ref: "#/components/schemas/HotelOrderOpsMeta"

    HotelOrderSummaryPage:
      type: object
      properties:
        page: { type: integer }
        limit: { type: integer }
        total: { type: integer }
        items:
          type: array
          items: { $ref: "#/components/schemas/HotelOrderListItem" }

    # ─────────── Order details (platform-level) ───────────
    HotelMini:
      type: object
      properties:
        id: { type: string, nullable: true }
        name: { type: string, nullable: true }
        category: { type: integer, nullable: true }
        address: { type: string, nullable: true }
        city: { type: string, nullable: true }
        country: { type: string, nullable: true }
        image: { type: string, nullable: true }

    HotelOrderDetails:
      type: object
      properties:
        hotel: { $ref: "#/components/schemas/HotelMini" }
        context:
          type: object
          properties:
            hotelSearchCode: { type: string, nullable: true }
            arrivalDate: { type: string, format: date, nullable: true }
            nights: { type: integer, nullable: true }
            roomBasis: { type: string, nullable: true }
        rooms:
          type: array
          items:
            type: object
            properties:
              roomId: { type: integer }
              category: { type: string, nullable: true }
              pax:
                type: array
                items: { $ref: "#/components/schemas/PaxPerson" }
        cancellation:
          $ref: "#/components/schemas/CancellationV2"
        remarksHtml: { type: string, nullable: true }
        price:
          type: object
          properties:
            retail: { $ref: "#/components/schemas/Money" }
            net: { $ref: "#/components/schemas/Money" }

    PaymentInfo:
      type: object
      properties:
        status:
          type: string
          enum: [unpaid, authorized, captured, paid, settled, refunded, partially_refunded, failed]
        method:
          type: string
          enum: [none, arca, deposit, manual]
          description: Matches order model (none/arca/deposit/manual)
        provider: { type: string, nullable: true }
        history:
          type: array
          items:
            type: object
            properties:
              at: { type: string, format: date-time }
              status: { type: string }
              note: { type: string, nullable: true }

    HotelOrderDetail:
      type: object
      properties:
        platformRef: { type: string }
        status:
          $ref: "#/components/schemas/HotelOrderPlatformStatus"
        statusLabel: { type: string }
        isPayable: { type: boolean }
        role: { type: string }
        supplier:
          type: object
          properties:
            code: { type: string, example: goglobal }
            bookingCode: { type: string, nullable: true }
            supplierRef: { type: string, nullable: true }
            rawStatus:
              $ref: "#/components/schemas/HotelOrderSupplierStatus"
            rawStatusLabel: { type: string }
        hotel:
          type: object
          properties:
            id: { type: string, nullable: true }
            name: { type: string, nullable: true }
            cityName: { type: string, nullable: true }
            countryName: { type: string, nullable: true }
        context:
          type: object
          properties:
            hotelSearchCode: { type: string, nullable: true }
            arrivalDate: { type: string, format: date, nullable: true }
            nights: { type: integer, nullable: true }
            roomsCount: { type: integer, nullable: true }
            roomBasis: { type: string, nullable: true }
        price:
          type: object
          properties:
            amount: { type: number, nullable: true }
            currency: { type: string, nullable: true }
            markupPct: { type: number, nullable: true }
        cancellation:
          $ref: "#/components/schemas/CancellationSummary"
        rooms:
          type: array
          items:
            type: object
            properties:
              roomId: { type: integer }
              pax:
                type: array
                items: { $ref: "#/components/schemas/PaxPerson" }
        supplierRemarksHtml: { type: string, nullable: true }
        clientRemark: { type: string, nullable: true }
        payment: { $ref: "#/components/schemas/PaymentInfo" }

    HotelOrderDetailResponse:
      type: object
      properties:
        order: { $ref: "#/components/schemas/HotelOrderDetail" }

    GoGlobalStatusTriplet:
      type: object
      properties:
        raw:
          type: string
          description: Supplier raw status (C, X, RX, RQ, VCH, VRQ…)
        status:
          type: string
          description: Platform-mapped status (C, X, RX, RQ, RJ, PENDING, FAILED)
        statusLabel:
          type: string
          description: Human readable label, e.g. Confirmed / Cancelled

    GoGlobalStatusSyncResponse:
      type: object
      properties:
        ok: { type: boolean }
        platformRef: { type: string }
        supplierRaw:
          type: string
          nullable: true
          description: Raw status returned from supplier after sync
        status:
          type: string
          description: Platform status after sync
        statusLabel: { type: string }
        changed:
          type: boolean
          description: Whether persisted platform/raw status changed
        prev:
          allOf:
            - $ref: "#/components/schemas/GoGlobalStatusTriplet"
          nullable: true
        next:
          allOf:
            - $ref: "#/components/schemas/GoGlobalStatusTriplet"
          nullable: true
        debugPreview:
          type: object
          nullable: true
          description: Present only when ?debug=1

    GoGlobalCancelByPlatformRefResponse:
      type: object
      properties:
        ok: { type: boolean }
        platformRef: { type: string }
        accepted:
          type: boolean
          description: Supplier accepted the cancel request (X or RX)
        supplierRaw:
          type: string
          nullable: true
        status:
          type: string
        statusLabel:
          type: string
        prev:
          allOf:
            - $ref: "#/components/schemas/GoGlobalStatusTriplet"
          nullable: true
        next:
          allOf:
            - $ref: "#/components/schemas/GoGlobalStatusTriplet"
          nullable: true

